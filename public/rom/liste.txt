import os
import csv
import re
import time
import requests
from bs4 import BeautifulSoup
from openai import OpenAI

# --- AYARLAR ---
# Oyunların bulunduğu klasör
OYUN_KLASORU = r"C:\Users\yucel\OneDrive\Desktop\oyunsitesi\roms\oyunlar\roms"

# OpenAI API Key (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)
OPENAI_API_KEY = "sk-BURAYA_OPENAI_API_KEY_YAZILACAK"

# CSV Çıktı adı
CIKTI_DOSYASI = "oyun_listesi_final_v2.csv"

# Aranacak uzantılar
UZANTILAR = ('.zip', '.iso', '.nes', '.sfc', '.md', '.bin', '.gba', '.exe')

# OpenAI İstemcisi
client = OpenAI(api_key=OPENAI_API_KEY)

def slugify(text):
    """URL uyumlu hale getirir"""
    text = text.lower()
    text = re.sub(r'[^a-z0-9\s-]', '', text) 
    text = re.sub(r'[\s]+', '-', text)       
    return text.strip('-')

def resim_bul_google(oyun_adi):
    """
    Google Görseller üzerinden ilk resmi bulmaya çalışır.
    DuckDuckGo engellediği için bu yöntemi kullanıyoruz.
    """
    query = f"{oyun_adi} box art"
    url = f"https://www.google.com/search?q={query}&tbm=isch"
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
    }
    
    try:
        response = requests.get(url, headers=headers, timeout=5)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # Google görsellerinde resimler genellikle 'img' etiketindedir.
        # İlk anlamlı resmi almaya çalışıyoruz.
        images = soup.find_all('img')
        
        for img in images:
            src = img.get('src')
            # Google logolarını veya boş resimleri atla, http ile başlayan ilk resmi al
            if src and src.startswith('http') and 'google' not in src:
                return src
                
    except Exception as e:
        print(f"  Resim hatası: {e}")
    
    return ""

def chatgpt_bilgi_al(oyun_adi):
    """ChatGPT'den oyunun kategorisini ve açıklamasını ister."""
    try:
        prompt = (
            f"Tell me about the video game '{oyun_adi}'. "
            f"Format the answer exactly like this: Category|Description. "
            f"Example: Platformer|Mario travels the mushroom kingdom to save peach. "
            f"Keep description under 20 words. If unknown, say Unknown|Unknown."
        )

        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            max_tokens=80
        )
        content = response.choices[0].message.content.strip()
        
        if "|" in content:
            parts = content.split("|", 1)
            return parts[0], parts[1]
        else:
            return "Unknown", content
            
    except Exception as e:
        print(f"  ChatGPT hatası: {e}")
        return "Retro Game", "Description unavailable"

def main():
    headers = ["Title", "GameURL", "ThumbnailURL", "Category", "Type", "Description"]
    veri_listesi = []

    print("İşlem başlıyor... (Ratelimit koruması için her oyunda 2 saniye bekliyoruz)")

    if not os.path.exists(OYUN_KLASORU):
        print(f"HATA: Klasör bulunamadı: {OYUN_KLASORU}")
        return

    dosyalar = [f for f in os.listdir(OYUN_KLASORU) if f.lower().endswith(UZANTILAR)]
    toplam_dosya = len(dosyalar)

    for index, dosya in enumerate(dosyalar, 1):
        dosya_adi, uzanti = os.path.splitext(dosya)
        
        # Dosya adını temizle
        temiz_ad = re.sub(r'\s*[\(\[].*?[\)\]]', '', dosya_adi).strip()
        
        # URL Formatı
        slug = slugify(temiz_ad)
        game_url = f"/roms/{slug}.md"
        
        print(f"[{index}/{toplam_dosya}] İşleniyor: {temiz_ad}")

        # 1. Resim Bul (Yeni Google Metodu)
        resim_url = resim_bul_google(temiz_ad)

        # 2. Bilgi Bul (ChatGPT)
        kategori, aciklama = chatgpt_bilgi_al(temiz_ad)

        row_data = {
            "Title": temiz_ad,
            "GameURL": game_url,
            "ThumbnailURL": resim_url,
            "Category": kategori.strip(),
            "Type": "Emulator",  # İstediğin gibi sabitlendi
            "Description": aciklama.strip()
        }

        veri_listesi.append([row_data[h] for h in headers])
        
        # Engel yememek için her işlemden sonra 2 saniye bekleme
        time.sleep(2)

    # Kaydet
    try:
        with open(CIKTI_DOSYASI, mode='w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            writer.writerow(headers)
            writer.writerows(veri_listesi)
        print(f"\nBİTTİ! Dosya oluşturuldu: {os.path.abspath(CIKTI_DOSYASI)}")
    except PermissionError:
        print("HATA: CSV dosyası açık. Lütfen Excel'i kapatıp tekrar dene.")

if __name__ == "__main__":
    main()